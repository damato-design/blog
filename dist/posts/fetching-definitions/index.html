<!DOCTYPE html><head><meta charset="UTF-8"><title>Fetching web component definitions</title><meta name="viewport" content="width=device-width"><meta name="description" content="Design Systems Hot Takes"><meta name="generator" content="Astro v3.5.5"><meta property="og:title" content="Fetching web component definitions"><meta property="og:description" content="Design Systems Hot Takes"><meta property="og:url" content="https://blog.damato.design/posts/fetching-definitions/"><meta property="og:image" content="https://blog.damato.design/og-images/fetching-definitions.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="og:image:alt" content="Donnie D'Amato's blog"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@donniedamato"><meta name="twitter:creator" content="@donniedamato"><meta name="twitter:title" content="Fetching web component definitions"><meta name="twitter:description" content="Design Systems Hot Takes"><meta name="twitter:image" content="https://blog.damato.design/og-images/fetching-definitions.png"><meta name="twitter:image:alt" content="Donnie D'Amato's blog"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=PT+Sans+Narrow:wght@700&display=swap" rel="stylesheet"><style>@font-face{font-family:Garamond Nova;src:url(/fonts/garamondnova-italic.woff2) format("woff2");weight:400}@font-face{font-family:Garamond Nova;src:url(/fonts/garamondnova-light.woff2) format("woff2");weight:300}*,*:before,*:after{box-sizing:border-box}:root{--content-width: 860px;--card-width: 260px;--box-surface-bg: #f9f9f4;--box-surface-fg: #111;--box-contrast-bg: #001;--box-contrast-fg: #fff;--box-raised-bg: #fff;--box-raised-fg: #000;--box-raised-shadow: drop-shadow(0 .1rem .5rem rgba(0, 0, 0, .1))}body{margin:0;font-family:Merriweather,Book Antiqua,Palatino,Palatino Linotype,Palatino LT STD,Georgia,serif;font-size:1rem;font-weight:300;line-height:1.5;background:var(--box-surface-bg);color:var(--box-surface-fg);margin-bottom:10vw}img{max-width:100%}a{color:inherit;text-decoration-color:var(--heat);font-weight:700}.max-width{max-width:min(var(--content-width) - 2rem,100vw - 2rem);margin-inline:auto}header[data-astro-cid-3ef6ksr2]{padding-block:2rem}.max-width[data-astro-cid-3ef6ksr2]{display:flex;justify-content:space-between;align-items:center;gap:1rem}a[data-astro-cid-3ef6ksr2]{color:inherit;display:flex;flex-direction:column;text-decoration:none;line-height:1;font-size:1.5em}h1[data-astro-cid-3ef6ksr2]{font-size:1rem;font-weight:400;line-height:1;font-family:Garamond Nova}
.spine[data-astro-cid-vevxbnpu]{display:grid;grid-template-columns:auto 1fr auto;border-radius:2px;overflow:hidden}.spine[data-astro-cid-vevxbnpu]:after{content:"";display:block;grid-column:1 / -1;height:100%;grid-row:1 / -1;position:relative;pointer-events:none;box-shadow:inset 0 1rem 2rem #c8c8c880,inset 0 -1rem 2rem #c8c8c880}.animal[data-astro-cid-vevxbnpu]{grid-row:1;grid-column:1;width:16vw;max-width:10rem;display:flex;align-items:center;background:black;padding:1rem}.animal[data-astro-cid-vevxbnpu] img[data-astro-cid-vevxbnpu]{background:white;transform:rotate(-90deg)}.title[data-astro-cid-vevxbnpu]{grid-row:1;grid-column:2;container-type:inline-size;display:flex;align-items:center;justify-content:center;color:#fff;flex:1;font-family:Garamond Nova}.title[data-astro-cid-vevxbnpu] h2[data-astro-cid-vevxbnpu]{font-weight:300;font-size:8cqi;text-wrap:balance;line-height:1.1;padding:.25em;margin:0}.title[data-astro-cid-vevxbnpu] span[data-astro-cid-vevxbnpu]{text-wrap:nowrap;padding:1em;margin-inline-start:auto}.publisher[data-astro-cid-vevxbnpu]{grid-row:1;grid-column:3;background:black;color:#fff;display:flex;align-items:center;padding:1rem;text-decoration:none;--heat: currentColor}article{font-size:1.2em}article :where(h2,h3,h4,h5,h6){font-family:PT Sans Narrow;text-transform:capitalize}article code{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;filter:brightness(.8)}article :not(pre)>code{color:var(--heat)}
</style></head><body style="--heat: #1AA8A7;"> <header data-astro-cid-3ef6ksr2> <div class="max-width" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2> <svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 784.03 144.72" fill="currentColor" width="6em">
	<path d="m119.8,44.52c-3.62-8.51-8.68-15.94-15.18-22.31-6.5-6.36-14.1-11.32-22.81-14.87-8.71-3.55-18.16-5.33-28.34-5.33H0v140.7h53.87c10.05,0,19.43-1.77,28.14-5.33,8.71-3.55,16.28-8.51,22.71-14.87,6.43-6.36,11.46-13.83,15.07-22.41,3.62-8.57,5.43-17.82,5.43-27.74s-1.81-19.33-5.43-27.84Zm-24.42,53.47c-4.09,7.44-9.78,13.23-17.08,17.39-7.31,4.15-15.78,6.23-25.43,6.23h-29.75V23.11h29.75c9.51,0,17.92,2.08,25.23,6.23,7.3,4.15,13.03,9.92,17.19,17.29,4.15,7.37,6.23,15.88,6.23,25.53s-2.04,18.39-6.13,25.83Z" />
	<path style="fill: var(--heat, currentColor);" d="m160.9,4.52c-3.01-3.02-6.53-4.52-10.55-4.52s-7.71,1.51-10.65,4.52c-2.95,3.02-4.42,6.67-4.42,10.95,0,4.02,1.31,7.34,3.92,9.95,1.87,1.87,3.86,3.06,5.98,3.59l-11.91,22.24,12.26,6.63,14.87-27.34c1.88-3.62,3.18-6.6,3.92-8.94.73-2.34,1.11-4.39,1.11-6.13,0-4.29-1.51-7.94-4.52-10.95Z" />
	<path class="cls-1" d="m239.37,142.71h24.93L206.81,2.01h-16.08l-57.89,140.7h24.52l10.82-27.13h60.47l10.72,27.13Zm-63.18-47.23l22.36-56.1,22.16,56.1h-44.52Z" />
	<polygon points="396.95 2.01 343.69 89.69 290.42 2.01 274.34 2.01 274.34 142.71 297.46 142.71 297.46 52.61 335.65 115.37 351.73 115.37 389.92 52.61 389.92 142.71 413.03 142.71 413.03 2.01 396.95 2.01" />
	<path d="m529.61,142.71h24.92L497.05,2.01h-16.08l-57.89,140.7h24.52l10.82-27.13h60.47l10.72,27.13Zm-63.18-47.23l22.36-56.09,22.16,56.09h-44.52Z" />
	<polygon points="642.9 2.01 528.13 2.01 528.13 23.11 573.96 23.11 573.96 142.71 597.07 142.71 597.07 23.11 642.9 23.11 642.9 2.01" />
	<path d="m712.67,144.72c-10.05,0-19.43-1.88-28.14-5.63-8.71-3.75-16.35-8.94-22.91-15.58-6.57-6.63-11.69-14.34-15.38-23.12-3.69-8.77-5.53-18.19-5.53-28.24s1.84-19.43,5.53-28.14c3.68-8.71,8.78-16.38,15.28-23.01,6.5-6.63,14.07-11.79,22.71-15.48,8.64-3.68,17.99-5.53,28.04-5.53s19.4,1.84,28.04,5.53c8.64,3.69,16.25,8.84,22.81,15.48,6.56,6.63,11.69,14.34,15.38,23.12,3.68,8.78,5.53,18.19,5.53,28.24s-1.84,19.47-5.53,28.24c-3.69,8.78-8.78,16.45-15.28,23.01-6.5,6.57-14.07,11.73-22.71,15.48-8.64,3.75-17.92,5.63-27.84,5.63Zm-.4-22.11c9.51,0,17.85-2.14,25.02-6.43,7.17-4.29,12.79-10.22,16.88-17.79,4.09-7.57,6.13-16.31,6.13-26.23,0-7.37-1.17-14.1-3.52-20.2-2.35-6.1-5.66-11.39-9.95-15.88-4.29-4.49-9.35-7.94-15.18-10.35s-12.29-3.62-19.4-3.62c-9.38,0-17.66,2.11-24.82,6.33-7.17,4.22-12.8,10.08-16.88,17.59-4.09,7.51-6.13,16.22-6.13,26.13,0,7.37,1.17,14.17,3.52,20.4,2.34,6.23,5.63,11.56,9.85,15.98,4.22,4.42,9.28,7.87,15.18,10.35,5.9,2.48,12.33,3.72,19.3,3.72Z" />
</svg>
 <h1 data-astro-cid-3ef6ksr2>Design Systems Hot Takes</h1> </a> <a href="/feed.xml" data-astro-cid-3ef6ksr2> <svg viewBox="0 0 512 512" style="enable-background:new 0 0 512 512" role="presentation" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" width="2rem" fill="currentColor"><path d="M119.9 336.1c-30.8 0-55.9 25.1-55.9 55.8 0 30.8 25.1 55.6 55.9 55.6 30.9 0 55.9-24.9 55.9-55.6 0-30.7-25-55.8-55.9-55.8z"></path><path d="M64 192v79.9c48 0 94.1 14.2 128 48.1 33.9 33.9 48 79.9 48 128h80c0-139.9-116-256-256-256z"></path><path d="M64 64v79.9c171 0 303.9 133 303.9 304.1H448C448 236.3 276 64 64 64z"></path></svg> </a> </div> </header> <div data-astro-cid-vevxbnpu> <div class="spine max-width" data-astro-cid-vevxbnpu> <div class="animal" data-astro-cid-vevxbnpu> <img src="/animals/labrador.png" data-astro-cid-vevxbnpu> </div> <div class="title" style="background: #1AA8A7" data-astro-cid-vevxbnpu> <h2 data-astro-cid-vevxbnpu>Fetching web component definitions</h2> <span data-astro-cid-vevxbnpu>8 min read</span> </div> <a class="publisher" href="/" data-astro-cid-vevxbnpu> <svg xmlns="http://www.w3.org/2000/svg" role="presentation" viewBox="0 0 784.03 144.72" fill="currentColor" width="6em">
	<path d="m119.8,44.52c-3.62-8.51-8.68-15.94-15.18-22.31-6.5-6.36-14.1-11.32-22.81-14.87-8.71-3.55-18.16-5.33-28.34-5.33H0v140.7h53.87c10.05,0,19.43-1.77,28.14-5.33,8.71-3.55,16.28-8.51,22.71-14.87,6.43-6.36,11.46-13.83,15.07-22.41,3.62-8.57,5.43-17.82,5.43-27.74s-1.81-19.33-5.43-27.84Zm-24.42,53.47c-4.09,7.44-9.78,13.23-17.08,17.39-7.31,4.15-15.78,6.23-25.43,6.23h-29.75V23.11h29.75c9.51,0,17.92,2.08,25.23,6.23,7.3,4.15,13.03,9.92,17.19,17.29,4.15,7.37,6.23,15.88,6.23,25.53s-2.04,18.39-6.13,25.83Z" />
	<path style="fill: var(--heat, currentColor);" d="m160.9,4.52c-3.01-3.02-6.53-4.52-10.55-4.52s-7.71,1.51-10.65,4.52c-2.95,3.02-4.42,6.67-4.42,10.95,0,4.02,1.31,7.34,3.92,9.95,1.87,1.87,3.86,3.06,5.98,3.59l-11.91,22.24,12.26,6.63,14.87-27.34c1.88-3.62,3.18-6.6,3.92-8.94.73-2.34,1.11-4.39,1.11-6.13,0-4.29-1.51-7.94-4.52-10.95Z" />
	<path class="cls-1" d="m239.37,142.71h24.93L206.81,2.01h-16.08l-57.89,140.7h24.52l10.82-27.13h60.47l10.72,27.13Zm-63.18-47.23l22.36-56.1,22.16,56.1h-44.52Z" />
	<polygon points="396.95 2.01 343.69 89.69 290.42 2.01 274.34 2.01 274.34 142.71 297.46 142.71 297.46 52.61 335.65 115.37 351.73 115.37 389.92 52.61 389.92 142.71 413.03 142.71 413.03 2.01 396.95 2.01" />
	<path d="m529.61,142.71h24.92L497.05,2.01h-16.08l-57.89,140.7h24.52l10.82-27.13h60.47l10.72,27.13Zm-63.18-47.23l22.36-56.09,22.16,56.09h-44.52Z" />
	<polygon points="642.9 2.01 528.13 2.01 528.13 23.11 573.96 23.11 573.96 142.71 597.07 142.71 597.07 23.11 642.9 23.11 642.9 2.01" />
	<path d="m712.67,144.72c-10.05,0-19.43-1.88-28.14-5.63-8.71-3.75-16.35-8.94-22.91-15.58-6.57-6.63-11.69-14.34-15.38-23.12-3.69-8.77-5.53-18.19-5.53-28.24s1.84-19.43,5.53-28.14c3.68-8.71,8.78-16.38,15.28-23.01,6.5-6.63,14.07-11.79,22.71-15.48,8.64-3.68,17.99-5.53,28.04-5.53s19.4,1.84,28.04,5.53c8.64,3.69,16.25,8.84,22.81,15.48,6.56,6.63,11.69,14.34,15.38,23.12,3.68,8.78,5.53,18.19,5.53,28.24s-1.84,19.47-5.53,28.24c-3.69,8.78-8.78,16.45-15.28,23.01-6.5,6.57-14.07,11.73-22.71,15.48-8.64,3.75-17.92,5.63-27.84,5.63Zm-.4-22.11c9.51,0,17.85-2.14,25.02-6.43,7.17-4.29,12.79-10.22,16.88-17.79,4.09-7.57,6.13-16.31,6.13-26.23,0-7.37-1.17-14.1-3.52-20.2-2.35-6.1-5.66-11.39-9.95-15.88-4.29-4.49-9.35-7.94-15.18-10.35s-12.29-3.62-19.4-3.62c-9.38,0-17.66,2.11-24.82,6.33-7.17,4.22-12.8,10.08-16.88,17.59-4.09,7.51-6.13,16.22-6.13,26.13,0,7.37,1.17,14.17,3.52,20.4,2.34,6.23,5.63,11.56,9.85,15.98,4.22,4.42,9.28,7.87,15.18,10.35,5.9,2.48,12.33,3.72,19.3,3.72Z" />
</svg>
 </a> </div> </div> <div class="max-width" style="--heat: #1AA8A7;"> <!-- <Navigation headings={ toc.get(1).children } /> --> <article style="--heat: #1AA8A7;"> <p>I love web components. Being able to just plop a custom element onto a page with all the functionality baked in without needing a framework or bundling to make it work is just liberating. I know there’s a lot of overhead that comes with it that libraries and frameworks aim to abstract but I just enjoy having the low-level ability to do whatever you want.</p>
<p>The trickiest part of web components for me has been how to identify when a web components, which is written as HTML, needs to be defined through JavaScript. From a performance point-of-view, we don’t want to send JavaScript to the page for components that aren’t there. On the flip side, we don’t want to miss components that apppear later in the lifecycle of the page.</p>
<p>The technique I’m about to explain is something I was working on at <a href="https://compass.com">Compass</a> but was never completed. Since then I’ve also enhanced the approach to be a bit easier to setup.</p>
<h2 id="registrar">Registrar</h2>
<p>The core of the approach uses an immediately invoked function expression (IIFE) which does a few things:</p>
<ul>
<li>Listens for new custom elements appearing on the page.</li>
<li>Fetches definitions for elements that are not defined.</li>
<li>Listens within new shadow roots for additional elements.</li>
</ul>
<p>Let’s describe how it does each of these.</p>
<h3 id="listening-for-new-custom-elements">Listening for new custom elements</h3>
<p>The <a href="https://davidwalsh.name/detect-node-insertion">technique for detecting when an element appears in the DOM</a> is not new. It was first discovered by <a href="http://www.backalleycoder.com/">Daniel Buchner</a> as early as 2012. This was the basis behind identifying when a custom element appears on the page with a few changes.</p>
<p>First, I use <code>visibility</code> as the trigger for the animation. The reason for this is because it is not commonly used for animations like <code>opacity</code> would be. This avoids possible conflicts where these elements would be animated more traditionally. So the declaration block that triggers the animation would begin to look like this:</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-color-text)">... {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">  animation</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> undefined-detection .1</span><span style="color:var(--astro-code-token-keyword)">ms</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">@keyframes</span><span style="color:var(--astro-code-color-text)"> undefined-detection {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  to { </span><span style="color:var(--astro-code-token-constant)">visibility</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> visible</span><span style="color:var(--astro-code-color-text)">; }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>The missing piece is the selector to target these custom elements. In my original implementation, I would generate the list of elements to find here however, there is a better way. Because what we are looking for is custom elements that are undefined, there’s a CSS selector that can target all of these.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-function)">:not</span><span style="color:var(--astro-code-color-text)">(:defined) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">  animation</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> undefined-detection .1</span><span style="color:var(--astro-code-token-keyword)">ms</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">@keyframes</span><span style="color:var(--astro-code-color-text)"> undefined-detection {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  to { </span><span style="color:var(--astro-code-token-constant)">visibility</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> visible</span><span style="color:var(--astro-code-color-text)">; }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>Yep, that’s it. Now the <code>undefined-detection</code> animation will trigger for all custom elements that are not yet defined.</p>
<p>{% aside %}</p>
<h3 id="greedy-registration">Greedy registration</h3>
<p>I’ve noticed that custom elements that are on the page from extensions or other libraries will also attempt to be requested and ultimately fail since they aren’t part of the library. This would be a benefit for having an explicit list of elements to listen for but the failures can be caught and ignored in this implementation or you could filter by prefix (i.e.; <code>ds-button</code> but not <code>random-button</code>).</p>
<p>{% endaside %}</p>
<p>So we will write this CSS to the <code>&#x3C;head/></code> of the page within the registrar and begin listening for the animation.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> 'undefined-detection'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> `</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  :not(:defined) { animation: </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> } </span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  @keyframes </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> { to { visibility: visible } }</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">`</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> registrar</span><span style="color:var(--astro-code-color-text)">() {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> observe</span><span style="color:var(--astro-code-color-text)">(root) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">root) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    root</span><span style="color:var(--astro-code-token-function)">.addEventListener</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'animationstart'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> onAnimationStart);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> styles</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> Object</span><span style="color:var(--astro-code-token-function)">.assign</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'style'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      type</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'text/css'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      textContent</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    });</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-token-function)">.insertBefore</span><span style="color:var(--astro-code-color-text)">(styles</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-color-text)">.lastChild);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> onAnimationStart</span><span style="color:var(--astro-code-color-text)">({ animationName</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target }) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (animationName </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">    // tagName is the custom element name</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> tagName</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> target</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">tagName</span><span style="color:var(--astro-code-token-function)">.toLowerCase</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">    // target is the element identified</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">  observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.documentElement);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">})()</span></span></code></pre>
<h2 id="fetching-the-definition">Fetching the definition</h2>
<p>This requires a bit of infrastructure. In my custom element library, each component is bundled into its own IIFE, available at <code>components/[COMPONENT_NAME].iife.js</code> in relation to the registrar. We can then determine the location of the components when the registrar is invoked with the following script.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">currentScript</span><span style="color:var(--astro-code-color-text)">.src).</span><span style="color:var(--astro-code-token-constant)">href</span><span style="color:var(--astro-code-token-function)">.replace</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">/[</span><span style="color:var(--astro-code-token-keyword)">^</span><span style="color:var(--astro-code-token-string-expression)">/]</span><span style="color:var(--astro-code-token-keyword)">*$</span><span style="color:var(--astro-code-token-string-expression)">/</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> ''</span><span style="color:var(--astro-code-color-text)">);</span></span></code></pre>
<p>The code above determines the url where the current script is located and then removes the <code>registrar.iife.js</code> file name. I haven’t found a cleaner way to do this without the ugly regex and without requiring to know the file name here. I wish browsers had the <a href="https://nodejs.org/api/path.html"><code>path</code> module from Node</a>.</p>
<p>Then we can determine the location of the components by building a url with this variable.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> src</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">`components/</span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-color-text)">tagName</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)">.iife.js`</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-color-text)">);</span></span></code></pre>
<p>From there, it’s easy to load the definition at this location. Here’s what the registrar looks like with this included.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> 'undefined-detection'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> `</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  :not(:defined) { animation: </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> } </span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  @keyframes </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> { to { visibility: visible } }</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">`</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">currentScript</span><span style="color:var(--astro-code-color-text)">.src).</span><span style="color:var(--astro-code-token-constant)">href</span><span style="color:var(--astro-code-token-function)">.replace</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">/[</span><span style="color:var(--astro-code-token-keyword)">^</span><span style="color:var(--astro-code-token-string-expression)">/]</span><span style="color:var(--astro-code-token-keyword)">*$</span><span style="color:var(--astro-code-token-string-expression)">/</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> ''</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> registrar</span><span style="color:var(--astro-code-color-text)">() {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  const</span><span style="color:var(--astro-code-token-constant)"> elements</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> Set</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> observe</span><span style="color:var(--astro-code-color-text)">(root) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">root) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    root</span><span style="color:var(--astro-code-token-function)">.addEventListener</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'animationstart'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> onAnimationStart);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> styles</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> Object</span><span style="color:var(--astro-code-token-function)">.assign</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'style'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      type</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'text/css'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      textContent</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    });</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-token-function)">.insertBefore</span><span style="color:var(--astro-code-color-text)">(styles</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-color-text)">.lastChild);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> onAnimationStart</span><span style="color:var(--astro-code-color-text)">({ animationName</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target }) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (animationName </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> tagName</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> target</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">tagName</span><span style="color:var(--astro-code-token-function)">.toLowerCase</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">    register</span><span style="color:var(--astro-code-color-text)">(tagName);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> register</span><span style="color:var(--astro-code-color-text)">(tagName) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-constant)">elements</span><span style="color:var(--astro-code-token-function)">.has</span><span style="color:var(--astro-code-color-text)">(tagName)) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    elements</span><span style="color:var(--astro-code-token-function)">.add</span><span style="color:var(--astro-code-color-text)">(tagName);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> Object</span><span style="color:var(--astro-code-token-function)">.assign</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'script'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      type</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'text/javascript'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      defer</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> true</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">      onload</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> () </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-function)">.remove</span><span style="color:var(--astro-code-color-text)">()</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">      onerror</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> () </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-function)">.remove</span><span style="color:var(--astro-code-color-text)">()</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      src</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">`components/</span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-color-text)">tagName</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)">.iife.js`</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    });</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-token-function)">.appendChild</span><span style="color:var(--astro-code-color-text)">(script);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">  observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.documentElement);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">})()</span></span></code></pre>
<p>The additional parts added are to ensure we don’t fetch definitions for things we are currently loading or have already loaded and to clean up the scripts being added to the page after they have completed.</p>
<h2 id="handling-shadow-roots">Handling shadow roots</h2>
<p>So we’ve solved for when custom elements appear on the page but not when they appear within other custom elements. There’s a little more work to do here.</p>
<p>When a custom element is identified, we’ll want to listen inside of its shadow root for undefined elements. We can do that in the event trigger.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> onAnimationStart</span><span style="color:var(--astro-code-color-text)">({ animationName</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target }) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  if</span><span style="color:var(--astro-code-color-text)"> (animationName </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  const</span><span style="color:var(--astro-code-token-constant)"> tagName</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> target</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">tagName</span><span style="color:var(--astro-code-token-function)">.toLowerCase</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">  register</span><span style="color:var(--astro-code-color-text)">(tagName);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">  // When the custom element is defined, begin looking for custom elements within</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">  window</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">customElements</span><span style="color:var(--astro-code-token-function)">.whenDefined</span><span style="color:var(--astro-code-color-text)">(tagName)</span><span style="color:var(--astro-code-token-function)">.then</span><span style="color:var(--astro-code-color-text)">(() </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-function)"> observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">target</span><span style="color:var(--astro-code-color-text)">.shadowRoot));</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>This will also require us to change the <code>observe</code> function since shadow roots do not have a <code>&#x3C;head/></code>. This is what the final registrar function looks like.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> 'undefined-detection'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-string-expression)"> `</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  :not(:defined) { animation: </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> } </span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">  @keyframes </span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">ANIMATION_NAME</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)"> { to { visibility: visible } }</span></span>
<span class="line"><span style="color:var(--astro-code-token-string-expression)">`</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">const</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">currentScript</span><span style="color:var(--astro-code-color-text)">.src).</span><span style="color:var(--astro-code-token-constant)">href</span><span style="color:var(--astro-code-token-function)">.replace</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">/[</span><span style="color:var(--astro-code-token-keyword)">^</span><span style="color:var(--astro-code-token-string-expression)">/]</span><span style="color:var(--astro-code-token-keyword)">*$</span><span style="color:var(--astro-code-token-string-expression)">/</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-string-expression)"> ''</span><span style="color:var(--astro-code-color-text)">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-keyword)">function</span><span style="color:var(--astro-code-token-function)"> registrar</span><span style="color:var(--astro-code-color-text)">() {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  const</span><span style="color:var(--astro-code-token-constant)"> elements</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> Set</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">  // Determine the anchor and target to set the resources</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> location</span><span style="color:var(--astro-code-color-text)">(root) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    return</span><span style="color:var(--astro-code-color-text)"> root </span><span style="color:var(--astro-code-token-keyword)">===</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-color-text)">.documentElement</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">      ?</span><span style="color:var(--astro-code-color-text)"> { anchor</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-color-text)">.head</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> document</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-color-text)">.lastChild }</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">      :</span><span style="color:var(--astro-code-color-text)"> { anchor</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> root</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> root</span><span style="color:var(--astro-code-color-text)">.firstChild };</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> observe</span><span style="color:var(--astro-code-color-text)">(root) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-keyword)">!</span><span style="color:var(--astro-code-color-text)">root) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    root</span><span style="color:var(--astro-code-token-function)">.addEventListener</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'animationstart'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> onAnimationStart);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> styles</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> Object</span><span style="color:var(--astro-code-token-function)">.assign</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'style'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      type</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'text/css'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      textContent</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> CSS</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-comment)">    // Here's where we determine where to attach the resources</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-color-text)"> { </span><span style="color:var(--astro-code-token-constant)">anchor</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> target</span><span style="color:var(--astro-code-color-text)"> } </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-function)"> location</span><span style="color:var(--astro-code-color-text)">(root);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    anchor</span><span style="color:var(--astro-code-token-function)">.insertBefore</span><span style="color:var(--astro-code-color-text)">(styles</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> onAnimationStart</span><span style="color:var(--astro-code-color-text)">({ animationName</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target }) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (animationName </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-constant)"> ANIMATION_NAME</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> tagName</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> target</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">tagName</span><span style="color:var(--astro-code-token-function)">.toLowerCase</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">    register</span><span style="color:var(--astro-code-color-text)">(tagName);</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    window</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">customElements</span><span style="color:var(--astro-code-token-function)">.whenDefined</span><span style="color:var(--astro-code-color-text)">(tagName)</span><span style="color:var(--astro-code-token-function)">.then</span><span style="color:var(--astro-code-color-text)">(() </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-function)"> observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">target</span><span style="color:var(--astro-code-color-text)">.shadowRoot));</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  function</span><span style="color:var(--astro-code-token-function)"> register</span><span style="color:var(--astro-code-color-text)">(tagName) {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    if</span><span style="color:var(--astro-code-color-text)"> (</span><span style="color:var(--astro-code-token-constant)">elements</span><span style="color:var(--astro-code-token-function)">.has</span><span style="color:var(--astro-code-color-text)">(tagName)) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    elements</span><span style="color:var(--astro-code-token-function)">.add</span><span style="color:var(--astro-code-color-text)">(tagName);</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">    const</span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-keyword)"> =</span><span style="color:var(--astro-code-token-constant)"> Object</span><span style="color:var(--astro-code-token-function)">.assign</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-token-function)">.createElement</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'script'</span><span style="color:var(--astro-code-color-text)">)</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      type</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'text/javascript'</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      defer</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> true</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">      onload</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> () </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-function)">.remove</span><span style="color:var(--astro-code-color-text)">()</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">      onerror</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-color-text)"> () </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-token-constant)"> script</span><span style="color:var(--astro-code-token-function)">.remove</span><span style="color:var(--astro-code-color-text)">()</span><span style="color:var(--astro-code-token-punctuation)">,</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">      src</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-keyword)"> new</span><span style="color:var(--astro-code-token-function)"> URL</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">`components/</span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-color-text)">tagName</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)">.iife.js`</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-token-constant)"> SOURCE_DIR</span><span style="color:var(--astro-code-color-text)">)</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">    });</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    document</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">head</span><span style="color:var(--astro-code-token-function)">.appendChild</span><span style="color:var(--astro-code-color-text)">(script);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:var(--astro-code-token-function)">  observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">document</span><span style="color:var(--astro-code-color-text)">.documentElement);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">})()</span></span></code></pre>
<h2 id="missing-pieces">Missing pieces</h2>
<p>One edge case that this approach might not catch is when custom elements are dynamically added to defined elements.</p>
<p>In other words, if <code>&#x3C;my-element></code> appears on the page, we define it and immediately add the listener to <em>only</em> that shadow root. While it does determine if any custom elements within its lifecycle need definitions, later <code>&#x3C;my-element></code> components added to the page will already be defined and therefore not trigger dynamically added custom elements within those later components (because the triggering resources aren’t added to subsquent shadow roots).</p>
<p>To have true coverage, the triggering resources would need to be added to <em>all</em> shadow roots. Luckily, this could be solved by importing the node detection CSS separately within each component which will trigger the registrar to fetch the definition; something that could be part of the library building script.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-keyword)">import</span><span style="color:var(--astro-code-color-text)"> CSS </span><span style="color:var(--astro-code-token-keyword)">from</span><span style="color:var(--astro-code-token-string-expression)"> '../registrar.js'</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">class</span><span style="color:var(--astro-code-token-function)"> MyElement</span><span style="color:var(--astro-code-token-keyword)"> extends</span><span style="color:var(--astro-code-token-function)"> window</span><span style="color:var(--astro-code-color-text)">.</span><span style="color:var(--astro-code-token-function)">HTMLElement</span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">  constructor</span><span style="color:var(--astro-code-color-text)">() {</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">    super</span><span style="color:var(--astro-code-color-text)">();</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">    this</span><span style="color:var(--astro-code-token-function)">.attachShadow</span><span style="color:var(--astro-code-color-text)">({ mode</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-string-expression)"> 'open'</span><span style="color:var(--astro-code-color-text)"> }).innerHTML </span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)"> `&#x3C;style type="text/css"></span><span style="color:var(--astro-code-token-keyword)">${</span><span style="color:var(--astro-code-token-constant)">CSS</span><span style="color:var(--astro-code-token-keyword)">}</span><span style="color:var(--astro-code-token-string-expression)">&#x3C;/style>`</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">  }</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">window</span><span style="color:var(--astro-code-token-function)">.</span><span style="color:var(--astro-code-token-constant)">customElements</span><span style="color:var(--astro-code-token-function)">.define</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'my-element'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> MyElement);</span></span></code></pre>
<p>{% aside %}</p>
<h3 id="listening-for-defined">Listening for defined</h3>
<p>You may have considered another approach to use node detection to just look for defined elements.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-color-text)">:defined {</span></span>
<span class="line"><span style="color:var(--astro-code-token-constant)">  animation</span><span style="color:var(--astro-code-token-keyword)">:</span><span style="color:var(--astro-code-token-constant)"> defined-detection .1</span><span style="color:var(--astro-code-token-keyword)">ms</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">}</span></span></code></pre>
<p>From there we could just add the target resources to each element; skipping the <code>customElements.whenDefined</code> check since the CSS animation trigger should catch it instead.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-token-constant)">root</span><span style="color:var(--astro-code-token-function)">.addEventListener</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-string-expression)">'animationend'</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> ({ animationName</span><span style="color:var(--astro-code-token-punctuation)">,</span><span style="color:var(--astro-code-color-text)"> target }) </span><span style="color:var(--astro-code-token-keyword)">=></span><span style="color:var(--astro-code-color-text)"> {</span></span>
<span class="line"><span style="color:var(--astro-code-token-keyword)">   if</span><span style="color:var(--astro-code-color-text)"> (animationName </span><span style="color:var(--astro-code-token-keyword)">!==</span><span style="color:var(--astro-code-token-string-expression)"> 'defined-detection'</span><span style="color:var(--astro-code-color-text)">) </span><span style="color:var(--astro-code-token-keyword)">return</span><span style="color:var(--astro-code-color-text)">;</span></span>
<span class="line"><span style="color:var(--astro-code-token-function)">   observe</span><span style="color:var(--astro-code-color-text)">(</span><span style="color:var(--astro-code-token-constant)">target</span><span style="color:var(--astro-code-color-text)">.shadowRoot);</span></span>
<span class="line"><span style="color:var(--astro-code-color-text)">})</span></span></code></pre>
<p>There’s one catch, the <code>:defined</code> selector will trigger for <em>all elements</em> (<code>&#x3C;html/></code>, <code>&#x3C;div/></code>, <code>&#x3C;p/></code>, etc.) and for every single one of them found on the page. While you could certainly filter for specific custom elements with open shadow roots, it’s still a lot of callbacks firing. Another reason why having a list of elements to update or pre-updating with the triggering resources seems to be better approaches.</p>
<p>{% endaside %}</p>
<h2 id="all-together-now">All together now</h2>
<p>Once you have the files bundled and deployed, you can just add the registrar to each page and it’ll begin fetching definitions. I’ll add <code>defer</code> so it doesn’t block the page from loading.</p>
<pre class="astro-code css-variables" style="background-color:var(--astro-code-color-background);color:var(--astro-code-color-text); overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:var(--astro-code-color-text)">&#x3C;</span><span style="color:var(--astro-code-token-string-expression)">script</span><span style="color:var(--astro-code-token-function)"> src</span><span style="color:var(--astro-code-token-keyword)">=</span><span style="color:var(--astro-code-token-string-expression)">"registrar.iife.js"</span><span style="color:var(--astro-code-token-function)"> defer</span><span style="color:var(--astro-code-color-text)">></span></span></code></pre>
<p>And that’s it, we’re automagically getting the definitions for web components on-demand!</p> </article> </div> </body>